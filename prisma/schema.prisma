generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider   = "postgresql"
  url        = env("DATABASE_URL")
  extensions = [vector]
}

model accounts {
  id                String  @id
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  users             users   @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model admin_settings {
  id          String   @id
  key         String   @unique
  value       Json
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime

  @@index([key])
}

model article_feedback {
  id            String   @id
  userId        String
  articleId     String
  feedbackType  String
  feedbackValue Float
  timeSpent     Int?
  estimatedTime Int?
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  articles      articles @relation(fields: [articleId], references: [id], onDelete: Cascade)
  users         users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@index([articleId])
  @@index([feedbackType])
  @@index([userId, createdAt])
  @@index([userId])
}

model articles {
  id               String                 @id
  feedId           String
  title            String
  content          String
  url              String                 @unique
  publishedAt      DateTime?
  embedding        Unsupported("vector")?
  createdAt        DateTime               @default(now())
  updatedAt        DateTime
  author           String?
  contentHash      String?
  excerpt          String?
  guid             String?
  imageUrl         String?
  keyPoints        Json?
  summary          String?
  topics           String[]
  article_feedback article_feedback[]
  feeds            feeds                  @relation(fields: [feedId], references: [id], onDelete: Cascade)
  read_articles    read_articles[]

  @@index([contentHash])
  @@index([feedId])
  @@index([feedId, publishedAt])
  @@index([guid])
  @@index([publishedAt])
  @@index([url])
}

model categories {
  id              String            @id
  name            String            @unique
  description     String?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  feed_categories feed_categories[]
}

model CronJobRun {
  id           String         @id @default(cuid())
  jobName      String
  status       CronJobStatus
  triggeredBy  CronJobTrigger
  startedAt    DateTime       @default(now())
  completedAt  DateTime?
  durationMs   Int?
  stats        Json?
  metadata     Json?
  errorMessage String?
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt

  @@index([jobName, startedAt])
  @@index([jobName, status])
  @@map("cron_job_runs")
}

model feed_categories {
  feedId     String
  categoryId String
  createdAt  DateTime   @default(now())
  categories categories @relation(fields: [categoryId], references: [id], onDelete: Cascade)
  feeds      feeds      @relation(fields: [feedId], references: [id], onDelete: Cascade)

  @@id([feedId, categoryId])
}

model feeds {
  id              String            @id
  name            String
  url             String            @unique
  lastFetched     DateTime?
  settings        Json?
  createdAt       DateTime          @default(now())
  updatedAt       DateTime
  description     String?
  errorCount      Int               @default(0)
  etag            String?
  fetchInterval   Int               @default(60)
  imageUrl        String?
  lastError       String?
  lastModified    String?
  siteUrl         String?
  articles        articles[]
  feed_categories feed_categories[]
  user_feeds      user_feeds[]

  @@index([errorCount])
  @@index([lastFetched])
  @@index([url])
}

model read_articles {
  id        String   @id
  userId    String
  articleId String
  readAt    DateTime @default(now())
  articles  articles @relation(fields: [articleId], references: [id], onDelete: Cascade)
  users     users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, articleId])
  @@index([articleId])
  @@index([userId])
  @@index([userId, readAt])
}

model sessions {
  id           String   @id
  sessionToken String   @unique
  userId       String
  expires      DateTime
  users        users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model user_categories {
  id                   String                 @id
  userId               String
  name                 String
  description          String?
  order                Int                    @default(0)
  settings             Json?
  createdAt            DateTime               @default(now())
  updatedAt            DateTime
  icon                 String?                @default("üìÅ")
  users                users                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  user_feed_categories user_feed_categories[]

  @@unique([userId, name])
  @@index([userId])
  @@index([userId, order])
}

model user_feed_categories {
  id              String          @id
  userFeedId      String
  userCategoryId  String
  createdAt       DateTime        @default(now())
  user_categories user_categories @relation(fields: [userCategoryId], references: [id], onDelete: Cascade)
  user_feeds      user_feeds      @relation(fields: [userFeedId], references: [id], onDelete: Cascade)

  @@unique([userFeedId, userCategoryId])
  @@index([userCategoryId])
  @@index([userFeedId])
}

model user_feeds {
  id                   String                 @id
  userId               String
  feedId               String
  customName           String?
  settings             Json?
  subscribedAt         DateTime               @default(now())
  updatedAt            DateTime
  user_feed_categories user_feed_categories[]
  feeds                feeds                  @relation(fields: [feedId], references: [id], onDelete: Cascade)
  users                users                  @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, feedId])
  @@index([feedId])
  @@index([userId])
}

model user_patterns {
  id            String   @id
  userId        String
  keyword       String
  weight        Float
  feedbackCount Int      @default(1)
  createdAt     DateTime @default(now())
  updatedAt     DateTime
  users         users    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, keyword])
  @@index([updatedAt])
  @@index([userId])
  @@index([userId, weight])
}

model user_preferences {
  id                        String   @id
  userId                    String   @unique
  theme                     String   @default("system")
  fontSize                  String   @default("medium")
  articlesPerPage           Int      @default(20)
  defaultView               String   @default("expanded")
  showReadArticles          Boolean  @default(true)
  autoMarkAsRead            Boolean  @default(false)
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime
  showRelatedExcerpts       Boolean  @default(false)
  bounceThreshold           Float    @default(0.25)
  showLowRelevanceArticles  Boolean  @default(true)
  llmApiKey                 String?
  llmBaseUrl                String?
  llmProvider               String?
  readingPanelEnabled       Boolean  @default(false)
  readingPanelPosition      String   @default("right")
  readingPanelSize          Int      @default(50)
  categoryStates            Json?
  sidebarCollapsed          Boolean  @default(false)
  readingFontFamily         String   @default("Georgia")
  readingFontSize           Int      @default(18)
  readingLineHeight         Float    @default(1.7)
  readingParagraphSpacing   Float    @default(1.5)
  showReadingTime           Boolean  @default(true)
  breakLineSpacing          Float    @default(0.75)
  defaultMaxArticleAge      Int      @default(90)
  defaultMaxArticlesPerFeed Int      @default(500)
  defaultRefreshInterval    Int      @default(60)
  articleSortDirection      String   @default("desc")
  articleSortOrder          String   @default("publishedAt")
  infiniteScrollMode        String   @default("both")
  searchRecencyDecayDays    Int      @default(30)
  searchRecencyWeight       Float    @default(0.3)
  embeddingsEnabled         Boolean  @default(false)
  llmSummaryModel           String?
  llmEmbeddingModel         String?
  llmDigestModel            String?
  users                     users    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model users {
  id               String             @id
  name             String?
  email            String             @unique
  emailVerified    DateTime?
  image            String?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime
  accounts         accounts[]
  article_feedback article_feedback[]
  read_articles    read_articles[]
  sessions         sessions[]
  user_categories  user_categories[]
  user_feeds       user_feeds[]
  user_patterns    user_patterns[]
  user_preferences user_preferences?
}

model verification_tokens {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

enum CronJobStatus {
  PENDING
  RUNNING
  SUCCESS
  FAILED
}

enum CronJobTrigger {
  SCHEDULER
  MANUAL
  SYSTEM
}
